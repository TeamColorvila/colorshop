(function($) {
$(document).ready(function() {

	// Hide review form - it will be in a lightbox
	$('#review_form_wrapper').hide();

	// Lightbox
	$("a.zoom").prettyPhoto({
		social_tools: false,
		theme: 'pp_colorshop',
		horizontal_padding: 40,
		opacity: 0.9,
		deeplinking: false
	});
	
	var isLoaded = false;
	$("a.show_review_form").prettyPhoto({
		social_tools: false,
		theme: 'pp_colorshop',
		horizontal_padding: 40,
		opacity: 0.9,
		deeplinking: false,
		default_width: 600,
		modal: true,
		callback: function() {
			jQuery('label').unbind('click');
		},
		changepicturecallback: function() {
			jQuery('.pp_colorshop .droparea').droparea({
                'instructions': 'drop a file or click to here',
                'init' : function(result){
                    //console.log('custom init',result);
                },
                'start' : function(area){
                    area.find('.error').remove(); 
                },
                'error' : function(result, input, area){
                	jQuery('<div class="error">').html(result.error).prependTo(area); 
                    return 0;
                },
                'complete' : function(result, file, input, area){
                	
                	//alert('111');
                	
                    if((/image/i).test(file.type)){
                    	
                        area.find('img').remove();
                        area.find(':hidden').remove();
                        area.append(jQuery('<img>',{'src': result.filename + '?' + Math.random()}));

                        //var file_name = area.find('input[type=file]').attr('data-tag');
                        //area.append(jQuery('<input>',{'type': 'hidden', 'name': file_name, 'value': result.filename}));

                        //console.debug(area);
                        area.parent().parent().next().show();
                        area.parent().parent().find('.clouse').show();
                        area.parent().parent().find('span').show();
                        
                        SetImageValue();
                    } 
                    //console.log('custom complete',result);
                }
            });
	            
            if(jQuery.browser.mozilla) {
            	var timesClicked = 0;
            	jQuery('label').on('click', function(e) {
        	    if(e.currentTarget === this && e.target.nodeName !== 'INPUT') {
        	    	jQuery(this.control).click();
        	    	return false;
        	    }
        	  });
        	}

            jQuery('.cs-photolist span.left').live('click', function(){
	            var $current_li = jQuery(this).parent();  
	            $current_li.insertBefore($current_li.prev());
	            SetImageValue();
        	});

            jQuery('.cs-photolist span.right').live('click', function(){
            	var $current_li = jQuery(this).parent();
            	var check = jQuery(this).parent().next().find('.clouse').is(':visible');
            	if (check) {
	            	$current_li.insertAfter($current_li.next());
	            	SetImageValue();
            	}
        	}); 

        	jQuery('.cs-photolist .clouse').live('click', function(){
        		var $current_li = jQuery(this).parent();
        		var $all_li = $current_li.parent().find('li');
        		
        		var find = false;
        		jQuery.each($all_li, function(index, value) {
            		if (jQuery(value).is(':visible') && jQuery(value).find('img').length == 0) {
            			find = true;
            		}
        		});
        		
        		if (find) {
        			$current_li.insertAfter($all_li.last()).hide();
        		} else {
        			if ($current_li.next().length > 0) {
        				$current_li.insertAfter($all_li.last()).show();	
        			}
        		}
        		
            	jQuery(this).prev().find('img').remove();
            	jQuery(this).prev().find('input[type=hidden]').remove();
            	jQuery(this).hide();
            	$current_li.find('span').hide();
            	SetImageValue();
         	});

        	function SetImageValue() {
            	jQuery('.pp_colorshop .cs-photolist ul li').each(function(index, value) {
            		//console.debug(jQuery(value));
                	var url = jQuery(value).find('img').attr('src');
                	var count = index + 1;
                	jQuery('input[name=img' + count +']').val(url);
            	});
        	}
		}
	});
	
//	$("a.show_pin_form").prettyPhoto({
//		social_tools: false,
//		theme: 'pp_colorshop',
//		horizontal_padding: 40,
//		opacity: 0.9,
//		deeplinking: false
//	});
	$("a[rel^='prettyPhoto']").prettyPhoto({
		social_tools: false,
		theme: 'pp_colorshop',
		horizontal_padding: 40,
		opacity: 0.9,
		deeplinking: false
	});

	// Open review form lightbox if accessed via anchor
	if( window.location.hash == '#review_form' ) {
		$('a.show_review_form').trigger('click');
	}
	
	if( window.location.hash == '#pin_form' ) {
		$('a.show_pin_form').trigger('click');
	}

});
})(jQuery);